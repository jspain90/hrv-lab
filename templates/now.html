<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>HRV-Lab â€” Now</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="stylesheet" href="/static/now.css">
</head>
<body>
  <div class="wrap">
    <h1>POTS Laboratory</h1>

    <!-- Tab navigation -->
    <div class="tab-nav">
      <button class="tab-button active" data-tab="compliance">Compliance</button>
      <button class="tab-button" data-tab="metrics">HRV Analysis</button>
      <button class="tab-button" data-tab="intervention-analysis">Intervention Analysis</button>
      <button class="tab-button" data-tab="new-intervention">Intervention Management</button>
      <button class="tab-button" data-tab="maintenance">Maintenance</button>
    </div>

    <!-- Compliance tab -->
    <div class="tab-content active" id="tab-compliance">
      <div class="card">
        <h3>Quick compliance</h3>
        <div class="row">
          {% if buttons %}
            {% for b in buttons %}
              <a href="{{ b.href }}" class="btn">{{ b.label }}</a>
            {% endfor %}
          {% else %}
            <em>No interventions yet.</em>
          {% endif %}
        </div>
      </div>

      <!-- Compliance Tracking Table -->
      <div class="card" style="margin-top: 24px;">
        <h3>Compliance Tracking</h3>

        <!-- Filter buttons -->
        <div style="margin-bottom: 16px; display: flex; gap: 12px;">
          <button
            id="activeFilterBtn"
            onclick="switchComplianceFilter('active')"
            style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
            Active Interventions
          </button>
          <button
            id="completedFilterBtn"
            onclick="switchComplianceFilter('completed')"
            style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Completed Interventions
          </button>
        </div>

        <!-- Table container -->
        <div id="complianceStatsContainer">
          <p style="color: #9ca3af;">Loading compliance data...</p>
        </div>
      </div>
    </div>

    <!-- Metrics tab -->
    <div class="tab-content" id="tab-metrics">
      <!-- Chart 1: TP Residual -->
      <div style="margin-bottom: 24px;">
        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 12px;">
          <select id="metric1" class="metric-select">
            <option value="total_power_ms2_ln">Total Power (ln)</option>
            <option value="total_power_ms2">Total Power</option>
            <option value="lf_ms2">LF</option>
            <option value="hf_ms2">HF</option>
            <option value="lf_hf">LF/HF Ratio</option>
            <option value="rmssd_ms">RMSSD</option>
            <option value="sdnn_ms">SDNN</option>
            <option value="hr_bpm">Heart Rate</option>
            <option value="tp_residual" selected>TP Residual (Intervention Effect)</option>
            <option value="lfhf_residual">LF/HF Residual</option>
            <option value="standing_hr">Standing Trial - HR</option>
          </select>
          <select id="dateRange1" class="metric-select" style="max-width: 150px;">
            <option value="7">Last 7 Days</option>
            <option value="14">Last 14 Days</option>
            <option value="30" selected>Last 30 Days</option>
            <option value="90">Last 90 Days</option>
            <option value="all">All Time</option>
          </select>
        </div>
        <canvas id="chart1" width="900" height="400"></canvas>
        <div id="legend1" class="intervention-legend">
          <strong>Intervention Legend:</strong>
          <div class="legend-items"></div>
        </div>
      </div>

      <!-- Chart 2: Standing Trial - HR -->
      <div style="margin-bottom: 24px;">
        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 12px;">
          <select id="metric2" class="metric-select">
            <option value="total_power_ms2_ln">Total Power (ln)</option>
            <option value="total_power_ms2">Total Power</option>
            <option value="lf_ms2">LF</option>
            <option value="hf_ms2">HF</option>
            <option value="lf_hf">LF/HF Ratio</option>
            <option value="rmssd_ms">RMSSD</option>
            <option value="sdnn_ms">SDNN</option>
            <option value="hr_bpm">Heart Rate</option>
            <option value="tp_residual">TP Residual (Intervention Effect)</option>
            <option value="lfhf_residual">LF/HF Residual</option>
            <option value="standing_hr" selected>Standing Trial - HR</option>
          </select>
          <select id="dateRange2" class="metric-select" style="max-width: 150px;">
            <option value="7">Last 7 Days</option>
            <option value="14">Last 14 Days</option>
            <option value="30">Last 30 Days</option>
            <option value="90">Last 90 Days</option>
            <option value="all" selected>All Time</option>
          </select>
        </div>
        <canvas id="chart2" width="900" height="400"></canvas>
        <div id="legend2" class="intervention-legend">
          <strong>Intervention Legend:</strong>
          <div class="legend-items"></div>
        </div>
      </div>

      <!-- Chart 3: Total Power -->
      <div style="margin-bottom: 24px;">
        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 12px;">
          <select id="metric3" class="metric-select">
            <option value="total_power_ms2_ln">Total Power (ln)</option>
            <option value="total_power_ms2" selected>Total Power</option>
            <option value="lf_ms2">LF</option>
            <option value="hf_ms2">HF</option>
            <option value="lf_hf">LF/HF Ratio</option>
            <option value="rmssd_ms">RMSSD</option>
            <option value="sdnn_ms">SDNN</option>
            <option value="hr_bpm">Heart Rate</option>
            <option value="tp_residual">TP Residual (Intervention Effect)</option>
            <option value="lfhf_residual">LF/HF Residual</option>
            <option value="standing_hr">Standing Trial - HR</option>
          </select>
          <select id="dateRange3" class="metric-select" style="max-width: 150px;">
            <option value="7">Last 7 Days</option>
            <option value="14">Last 14 Days</option>
            <option value="30">Last 30 Days</option>
            <option value="90">Last 90 Days</option>
            <option value="all" selected>All Time</option>
          </select>
        </div>
        <canvas id="chart3" width="900" height="400"></canvas>
        <div id="legend3" class="intervention-legend">
          <strong>Intervention Legend:</strong>
          <div class="legend-items"></div>
        </div>
      </div>
    </div>

    <!-- Intervention Analysis tab -->
    <div class="tab-content" id="tab-intervention-analysis">
      <div class="card">
        <h3>Intervention Analysis</h3>
        <p style="color: #9ca3af; margin-bottom: 16px;">
          Tau-U effect size analysis for completed interventions. Compares intervention period against matched baseline period.
        </p>
        <div id="interventionAnalysisContainer">
          <p style="color: #9ca3af;">Loading analysis data...</p>
        </div>
      </div>
    </div>

    <!-- New Intervention tab -->
    <div class="tab-content" id="tab-new-intervention">
      <div class="card">
        <h3>New Intervention</h3>
        <form id="interventionForm">
          <div style="margin-bottom: 12px;">
            <label for="name">Name:</label>
            <input type="text" id="name" name="name" required style="width: 100%;">
          </div>
          <div style="margin-bottom: 12px;">
            <label for="start_date">Start Date:</label>
            <input type="date" id="start_date" name="start_date" required style="width: 100%;">
          </div>
          <div style="margin-bottom: 12px;">
            <label for="duration_weeks">Duration (weeks):</label>
            <input type="number" id="duration_weeks" name="duration_weeks" min="1" required style="width: 100%;">
          </div>
          <div style="margin-bottom: 12px;">
            <label for="frequency_per_week">Frequency per week:</label>
            <input type="number" id="frequency_per_week" name="frequency_per_week" min="1" required style="width: 100%;">
          </div>
          <button type="submit">Create Intervention</button>
          <div id="interventionStatus"></div>
        </form>
      </div>

      <div class="card">
        <h3>Manage Interventions</h3>
        <div id="interventionsList" style="margin-top: 12px;">
          <p style="color: #b0b3b8;">Loading interventions...</p>
        </div>
      </div>
    </div>

    <!-- Maintenance tab -->
    <div class="tab-content" id="tab-maintenance">
      <div class="card">
        <h3>Maintenance</h3>
        <button id="refreshBtn">Refresh data</button>
        <pre id="refreshOut"></pre>
      </div>
    </div>
  </div>

  <!-- Edit Intervention Modal -->
  <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: #24272e; padding: 24px; border-radius: 12px; max-width: 500px; width: 90%; border: 1px solid #3a3d44; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);">
      <h3 style="margin-top: 0;">Edit Intervention</h3>
      <form id="editInterventionForm">
        <input type="hidden" id="edit_id">
        <div style="margin-bottom: 12px;">
          <label for="edit_name">Name:</label>
          <input type="text" id="edit_name" required style="width: 100%;">
        </div>
        <div style="margin-bottom: 12px;">
          <label for="edit_start_date">Start Date:</label>
          <input type="date" id="edit_start_date" required style="width: 100%;">
        </div>
        <div style="margin-bottom: 12px;">
          <label for="edit_duration_weeks">Duration (weeks):</label>
          <input type="number" id="edit_duration_weeks" min="1" required style="width: 100%;">
        </div>
        <div style="margin-bottom: 12px;">
          <label for="edit_frequency_per_week">Frequency per week:</label>
          <input type="number" id="edit_frequency_per_week" min="1" required style="width: 100%;">
        </div>
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button type="submit">Save Changes</button>
          <button type="button" onclick="closeEditModal()" style="background: #6b7280;">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/static/now.js"></script>
</body>
</html>
